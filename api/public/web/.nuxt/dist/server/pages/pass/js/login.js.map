{"version":3,"file":"pages/pass/js/login.js","sources":["webpack:///./api/sweepLogin.js","webpack:///./pages/pass/js/login.js"],"sourcesContent":["import request from '@/plugins/request'\r\nimport Qs from 'qs'\r\nexport function code() {\r\n  return request({\r\n    url: 'sweepLogin',\r\n    method: 'GET'\r\n  })\r\n}\r\nexport function verify(data) {\r\n  data = Qs.parse(data)\r\n  return request({\r\n    url: 'sweepLogin/verify',\r\n    method: 'POST',\r\n    data\r\n  })\r\n}\r\nexport function index(data) {\r\n  data = Qs.parse(data)\r\n  return request({\r\n    url: 'sweepLogin',\r\n    method: 'POST',\r\n    data\r\n  })\r\n}\r\n","import {login} from '@/api/login'\r\nimport {code, verify, index} from '@/api/sweepLogin'\r\nimport {verifyPlugin} from '@/api/plugin'\r\nimport {\r\n  mapMutations\r\n} from 'vuex';\r\nexport default {\r\n  layout: 'login',\r\n  head () {\r\n    return {\r\n      title: '登录' + '-' + process.env.APP_NAME\r\n    }\r\n  },\r\n  async asyncData (ctx) {\r\n    try {\r\n      let isSweepLogin = false\r\n      await verifyPlugin('sweepLogin').then(response => {\r\n        isSweepLogin = response.sweepLogin\r\n      })\r\n      return {\r\n        isSweepLogin: isSweepLogin\r\n      }\r\n    } catch(err) {\r\n      ctx.$errorHandler(err)\r\n    }\r\n  },\r\n  data() {\r\n    const validateCellphone = (rule, value, callback) => {\r\n      if (value === '') {\r\n        callback(new Error('请输入手机号'));\r\n      } else {\r\n        const myreg = /^1[3456789]\\d{9}$/;\r\n        if (!myreg.test(value)) {\r\n          callback(new Error('手机号格式有误'));\r\n        }\r\n        callback();\r\n      }\r\n    };\r\n    return {\r\n      isSweepLogin: false,\r\n      method: 1,\r\n      codeLoading: false,\r\n      codeImg: '',\r\n      codeTimer: null,\r\n      codeState: 0,\r\n      codeTime: 0,\r\n      codeUuid: 0,\r\n      ruleForm: {\r\n        cellphone: '',\r\n        password: '',\r\n        remember: false\r\n      },\r\n      loading: false,\r\n      rules: {\r\n        cellphone: [\r\n          { validator: validateCellphone, trigger: 'blur' }\r\n        ],\r\n        password: [\r\n          { required: true, message: '请输入密码', trigger: 'blur' },\r\n          { min: 5, message: '密码长度必须大于5位', trigger: 'blur' }\r\n        ]\r\n      }\r\n    }\r\n  },\r\n  beforeDestroy() {\r\n    clearInterval(this.codeTimer)\r\n  },\r\n  methods: {\r\n    ...mapMutations(['login']),\r\n    setMethod(index){\r\n      this.method = index\r\n      if(index === 2){\r\n        this.getCode()\r\n      }\r\n    },\r\n    // 获取二维码\r\n    getCode(){\r\n      this.codeLoading = true\r\n      this.codeState = 0\r\n      if(this.codeTimer){\r\n        clearInterval(this.codeTimer);\r\n      }\r\n      code().then(response => {\r\n        this.codeImg = response.code\r\n        this.codeTime = response.expires_in\r\n        this.codeUuid = response.uuid\r\n        this.codeTimer = setInterval(this.getRefreshCode, 2000);\r\n      }).finally(() => {\r\n        this.codeLoading = false\r\n      })\r\n    },\r\n    // 刷新登录状态\r\n    getRefreshCode(){\r\n      this.codeTime = this.codeTime-1\r\n      if (this.codeTime === 0) {\r\n        clearInterval(this.codeTimer);\r\n        this.codeState = 4\r\n      } else {\r\n        verify({uuid: this.codeUuid}).then(response => {\r\n          this.codeState = response.state\r\n          if(this.codeState !== 0 && this.codeState !== 1){\r\n            clearInterval(this.codeTimer);\r\n          }\r\n          if(this.codeState === 2){\r\n            index({\r\n              uuid: this.codeUuid\r\n            }).then(response => {\r\n              this.login(response);\r\n              this.$message({\r\n                message: '登录成功',\r\n                type: 'success'\r\n              });\r\n              this.loading = false;\r\n              const route = this.store.get('route');\r\n              if(route){\r\n                this.store.remove('route');\r\n                this.$router.replace({ path: route.path, query: route.query })\r\n              }else{\r\n                $nuxt.$router.replace('/user/portal')\r\n              }\r\n            }).catch(() => {\r\n              this.loading = false\r\n            })\r\n          }\r\n        })\r\n      }\r\n\r\n    },\r\n    toLogin(){\r\n      this.$refs['ruleForm'].validate((valid) => {\r\n        if (valid) {\r\n          this.loading = true;\r\n          login(this.ruleForm).then(response => {\r\n            response.remember = this.ruleForm.remember\r\n            this.login(response);\r\n            this.$message({\r\n              message: '登录成功',\r\n              type: 'success'\r\n            });\r\n            this.loading = false;\r\n            const route = this.store.get('route');\r\n            if(route){\r\n              this.store.remove('route');\r\n              this.$router.replace({ path: route.path, query: route.query })\r\n            }else{\r\n              $nuxt.$router.replace('/user/portal')\r\n            }\r\n          }).catch(() => {\r\n            this.loading = false\r\n          })\r\n        }\r\n      })\r\n    }\r\n  }\r\n}\r\n"],"mappings":";;;;;;;;;;;;;;;;;;;;;AAAA;AACA;AACA;AACA;AACA;AACA;AAFA;AAIA;AACA;AACA;AACA;AACA;AACA;AACA;AAHA;AAKA;AACA;AACA;AACA;AACA;AACA;AACA;AAHA;AAKA;;;;;;;;ACvBA;AACA;AACA;AACA;AAGA;AACA;AACA;AAAA;AACA;AACA;AADA;AAGA;AACA;AAAA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AADA;AAGA;AACA;AACA;AACA;AACA;AAAA;AACA;AACA;AACA;AACA;AACA;AACA;AAAA;AACA;AACA;AACA;AAAA;AACA;AACA;AACA;AAAA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AAHA;AAKA;AACA;AACA;AACA;AAAA;AAAA;AAEA;AACA;AAAA;AAAA;AAAA;AACA;AAAA;AAAA;AAAA;AANA;AAfA;AAyBA;AACA;AAAA;AACA;AACA;AACA;AAAA;AACA;AACA;AACA;AACA;AAAA;AACA;AACA;AACA;AACA;AAAA;AACA;AACA;AACA;AACA;AAAA;AACA;AACA;AACA;AAAA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AAAA;AACA;AACA;AACA;AAAA;AACA;AACA;AACA;AACA;AAAA;AAAA;AACA;AACA;AAAA;AACA;AACA;AACA;AAAA;AACA;AACA;AADA;AAGA;AACA;AACA;AACA;AAFA;AAIA;AACA;AACA;AAAA;AACA;AACA;AAAA;AAAA;AAAA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AAEA;AACA;AAAA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AAFA;AAIA;AACA;AACA;AAAA;AACA;AACA;AAAA;AAAA;AAAA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AAtFA;AA7DA;;;;A","sourceRoot":""}